<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YouTube Subscription Timeline</title>

    <!-- React / ReactDOM / Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- lucide icons -->
    <script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.js"></script>
  </head>

  <body class="bg-gray-900 text-white min-h-screen flex flex-col items-center p-4">
    <div id="root" class="w-full max-w-4xl"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // ✅ lucideアイコン描画（UMD版対応）
 const Icon = ({ name, size = 24, color = "currentColor" }) => {
  try {
    const iconData = lucide.icons[name];
    if (!iconData) return null;

    // lucide.createElement でSVGノードを生成
    const svgElement = lucide.createElement(iconData);

    // サイズと色を適用
    svgElement.setAttribute("width", size);
    svgElement.setAttribute("height", size);
    svgElement.setAttribute("stroke", color);
    svgElement.setAttribute("fill", "none");
    svgElement.setAttribute("stroke-width", "2");

    return (
      <span
        style={{ pointerEvents: "none", display: "inline-flex", verticalAlign: "middle" }}
        dangerouslySetInnerHTML={{ __html: svgElement.outerHTML }}
      />
    );
  } catch (e) {
    console.error("Icon render error:", name, e);
    return null;
  }
};

      const API_KEY = "AIzaSyDbZFuM6Kk7LkpTD3gXFCZAil784fdE6xA";
      const CLIENT_ID =
        "652862433755-rm9f5j7ln9qgcebi7sptkvifle4k8a9v.apps.googleusercontent.com";
      const REDIRECT_URI = window.location.origin + window.location.pathname;
      const SCOPES = "https://www.googleapis.com/auth/youtube.readonly";

      function YouTubeSubscriptionTimeline() {
        const [isSignedIn, setIsSignedIn] = useState(false);
        const [videos, setVideos] = useState([]);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState(null);
        const [selectedVideo, setSelectedVideo] = useState(null);
        const [accessToken, setAccessToken] = useState(null);

        // Google OAuth
        const handleAuth = () => {
          const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=${SCOPES}`;
          window.location = authUrl;
        };

        // トークン取得
        useEffect(() => {
          const hashParams = new URLSearchParams(window.location.hash.substring(1));
          const token = hashParams.get("access_token");
          if (token) {
            setAccessToken(token);
            setIsSignedIn(true);
            window.history.replaceState({}, document.title, window.location.pathname);
          }
        }, []);

        const fetchVideos = async (token) => {
          setLoading(true);
          try {
            const cacheKey = "youtubeVideosCache";
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
              const { data, timestamp } = JSON.parse(cached);
              if (Date.now() - timestamp < 12 * 60 * 60 * 1000) { // 12時間キャッシュ
                setVideos(data);
                setLoading(false);
                return;
              }
            }
        
            // 1️⃣ 購読チャンネル一覧を取得
            const subsResponse = await fetch(
              `https://www.googleapis.com/youtube/v3/subscriptions?part=snippet&mine=true&maxResults=50`,
              { headers: { Authorization: `Bearer ${token}` } }
            );
            const subsData = await subsResponse.json();
            if (!subsData.items) throw new Error("チャンネル一覧が取得できませんでした");
            const channelIds = subsData.items.map(
              (item) => item.snippet.resourceId.channelId
            );
        
            // 2️⃣ 各チャンネルの uploads playlist を取得
            const uploadsMap = {};
            for (const batch of Array.from({ length: Math.ceil(channelIds.length / 10) }, (_, i) =>
              channelIds.slice(i * 10, (i + 1) * 10)
            )) {
              const channelsResponse = await fetch(
                `https://www.googleapis.com/youtube/v3/channels?part=contentDetails&id=${batch.join(",")}`,
                { headers: { Authorization: `Bearer ${token}` } }
              );
              const channelsData = await channelsResponse.json();
              if (channelsData.items) {
                channelsData.items.forEach((ch) => {
                  uploadsMap[ch.id] = ch.contentDetails.relatedPlaylists.uploads;
                });
              }
            }
        
            // 3️⃣ 各 uploads playlist から最新動画を取得（クォータ1unit/playlist）
            const allVideos = [];
            for (const uploadsId of Object.values(uploadsMap)) {
              const playlistResponse = await fetch(
                `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${uploadsId}&maxResults=3`,
                { headers: { Authorization: `Bearer ${token}` } }
              );
              const playlistData = await playlistResponse.json();
              if (playlistData.items) allVideos.push(...playlistData.items);
            }
        
            // 4️⃣ 公開日順で最新10件だけ残す
            allVideos.sort(
              (a, b) =>
                new Date(b.snippet.publishedAt) - new Date(a.snippet.publishedAt)
            );
            const latest10 = allVideos.slice(0, 10);
        
            setVideos(latest10);
            setError(null);
        
            // 5️⃣ キャッシュ保存
            localStorage.setItem(
              cacheKey,
              JSON.stringify({ data: latest10, timestamp: Date.now() })
            );
          } catch (err) {
            console.error("YouTube API error:", err);
            setError("動画の取得中にエラーが発生しました。");
          } finally {
            setLoading(false);
          }
        };


        useEffect(() => {
          if (accessToken) fetchVideos(accessToken);
        }, [accessToken]);

        return (
          <div className="w-full">
            <h1 className="text-2xl font-bold mb-4 flex items-center gap-2">
              <Icon name="Video" /> YouTube Subscription Timeline
            </h1>

            {!isSignedIn ? (
              <button
                onClick={handleAuth}
                className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded flex items-center gap-2"
              >
                <Icon name="LogIn" /> Googleでログイン
              </button>
            ) : (
              <>
                <div className="flex justify-between items-center mb-4">
                  <button
                    onClick={() => fetchVideos(accessToken)}
                    className="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded flex items-center gap-2"
                  >
                    <Icon name="RefreshCw" /> 更新
                  </button>
                  <button
                    onClick={() => {
                      setIsSignedIn(false);
                      setAccessToken(null);
                    }}
                    className="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded flex items-center gap-2"
                  >
                    <Icon name="LogOut" /> ログアウト
                  </button>
                </div>

                {loading && <p>読み込み中...</p>}
                {error && <p className="text-red-400">{error}</p>}

                {selectedVideo ? (
                  <div className="mt-4">
                    <button
                      onClick={() => setSelectedVideo(null)}
                      className="text-blue-400 underline mb-2"
                    >
                      ← 一覧に戻る
                    </button>
                    <div className="aspect-video">
                      <iframe
                        width="100%"
                        height="315"
                        src={`https://www.youtube.com/embed/${selectedVideo.id.videoId}`}
                        allowFullScreen
                      ></iframe>
                    </div>
                  </div>
                ) : (
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    {videos.map((video) => (
                      <div
                        key={video.id.videoId}
                        onClick={() => setSelectedVideo(video)}
                        className="bg-gray-800 rounded-lg overflow-hidden cursor-pointer hover:bg-gray-750 transition group relative z-10"
                      >
                        <img
                          src={video.snippet.thumbnails.medium.url}
                          alt={video.snippet.title}
                          className="w-full"
                        />
                        <div className="p-2">
                          <p className="text-sm font-semibold group-hover:text-blue-400">
                            {video.snippet.title}
                          </p>
                          <p className="text-xs text-gray-400">
                            {new Date(video.snippet.publishedAt).toLocaleString()}
                          </p>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </>
            )}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(
        <YouTubeSubscriptionTimeline />
      );
    </script>
  </body>
</html>
