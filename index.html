<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>YouTube Subscription Timeline</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- ✅ lucide の React 版ではなく純JS版を使用 -->
    <script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>

  <body class="bg-gray-900">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // React 内で直接 lucide のSVGを描画
      const Icon = ({ name, size = 24, color = "currentColor" }) => {
        const icon = lucide.icons[name];
        if (!icon) return null;
        const svg = icon.toSvg({ width: size, height: size, color });
        return (
          <span
            style={{ pointerEvents: "none" }}  // ← これを追加！
            dangerouslySetInnerHTML={{ __html: svg }}
          />
        );
      };

      const API_KEY = "AIzaSyAQj9_bs47GFmHx4dhOM_DVwWhj0gT2ma0";
      const CLIENT_ID = "209571413251-6d0i4q3ud75boi9k874e1s0mhf4t53aa.apps.googleusercontent.com";
      const REDIRECT_URI = window.location.origin + window.location.pathname;
      const SCOPES = "https://www.googleapis.com/auth/youtube.readonly";

      function YouTubeSubscriptionTimeline() {
        const [isSignedIn, setIsSignedIn] = useState(false);
        const [videos, setVideos] = useState([]);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState(null);
        const [selectedVideo, setSelectedVideo] = useState(null);
        const [accessToken, setAccessToken] = useState(null);

        useEffect(() => {
          lucide.createIcons(); // ✅ 初期化

          const hash = window.location.hash.substring(1);
          const params = new URLSearchParams(hash);
          const token = params.get("access_token");
          if (token) {
            setAccessToken(token);
            setIsSignedIn(true);
            window.history.replaceState({}, document.title, window.location.pathname);
            fetchSubscriptionVideos(token);
          } else {
            const storedToken = localStorage.getItem("youtube_access_token");
            const expiryTime = localStorage.getItem("youtube_token_expiry");
            if (storedToken && expiryTime && Date.now() < parseInt(expiryTime)) {
              setAccessToken(storedToken);
              setIsSignedIn(true);
              fetchSubscriptionVideos(storedToken);
            }
          }
        }, []);

        useEffect(() => {
          lucide.createIcons(); // ✅ 再描画のたびに更新
        });

        useEffect(() => {
          if (accessToken) {
            localStorage.setItem("youtube_access_token", accessToken);
            localStorage.setItem("youtube_token_expiry", (Date.now() + 3600000).toString());
          }
        }, [accessToken]);

        const handleSignIn = () => {
          const authUrl =
            "https://accounts.google.com/o/oauth2/v2/auth?" +
            `client_id=${CLIENT_ID}` +
            `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
            `&response_type=token` +
            `&scope=${encodeURIComponent(SCOPES)}` +
            `&include_granted_scopes=true`;
          window.location.href = authUrl;
        };

        const handleSignOut = () => {
          localStorage.removeItem("youtube_access_token");
          localStorage.removeItem("youtube_token_expiry");
          setIsSignedIn(false);
          setAccessToken(null);
          setVideos([]);
          setSelectedVideo(null);
        };

        const fetchSubscriptionVideos = async (token) => {
          setLoading(true);
          setError(null);
          try {
            const subsResponse = await fetch(
              `https://www.googleapis.com/youtube/v3/subscriptions?part=snippet&mine=true&maxResults=50`,
              { headers: { Authorization: `Bearer ${token}` } }
            );
            if (!subsResponse.ok) {
              if (subsResponse.status === 401) {
                handleSignOut();
                throw new Error("認証の有効期限が切れました。再度ログインしてください。");
              }
              throw new Error("購読チャンネルの取得に失敗しました");
            }
            const subsData = await subsResponse.json();
            const channelIds = subsData.items.map((item) => item.snippet.resourceId.channelId);
            const allVideos = [];
            for (const channelId of channelIds.slice(0, 2)) {
              try {
                const videosResponse = await fetch(
                  `https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${channelId}&order=date&type=video&maxResults=3`,
                  { headers: { Authorization: `Bearer ${token}` } }
                );
                if (videosResponse.ok) {
                  const videosData = await videosResponse.json();
                  allVideos.push(...videosData.items);
                }
              } catch (err) {
                console.error(`Failed to fetch videos for channel ${channelId}`, err);
              }
            }
            allVideos.sort((a, b) => new Date(b.snippet.publishedAt) - new Date(a.snippet.publishedAt));
            setVideos(allVideos.slice(0, 50));
          } catch (err) {
            setError(err.message);
          } finally {
            setLoading(false);
          }
        };

        const handleRefresh = () => {
          if (accessToken) fetchSubscriptionVideos(accessToken);
        };

        const formatDate = (dateString) => {
          const date = new Date(dateString);
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMs / 3600000);
          const diffDays = Math.floor(diffMs / 86400000);
          if (diffMins < 60) return `${diffMins}分前`;
          if (diffHours < 24) return `${diffHours}時間前`;
          if (diffDays < 7) return `${diffDays}日前`;
          return date.toLocaleDateString("ja-JP");
        };

        if (!isSignedIn) {
          return (
            <div className="min-h-screen flex items-center justify-center p-4">
              <div className="bg-gray-800 rounded-lg p-8 max-w-md w-full text-center">
                <Icon name="video" size={64} color="#ef4444" />
                <h1 className="text-2xl font-bold text-white mb-2">購読チャンネル専用タイムライン</h1>
                <p className="text-gray-400 mb-6">おすすめや関連動画に惑わされず、<br />購読チャンネルの動画だけを見よう</p>
                {error && (
                  <div className="bg-red-900/50 border border-red-700 text-red-200 rounded-lg p-3 mb-4 text-sm">{error}</div>
                )}
                <button onClick={handleSignIn} className="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg w-full transition">
                  Googleでログイン
                </button>
              </div>
            </div>
          );
        }

        return (
          <div className="min-h-screen">
            <div className="bg-gray-800 border-b border-gray-700 sticky top-0 z-10">
              <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div className="flex items-center gap-3 text-white font-bold text-xl">
                  <Icon name="video" color="#ef4444" /> 購読チャンネル
                </div>
                <div className="flex items-center gap-2">
                  <button onClick={handleRefresh} disabled={loading} className="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-lg transition disabled:opacity-50" title="更新">
                    <Icon name="refresh-cw" />
                  </button>
                  <button onClick={handleSignOut} className="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition">
                    <Icon name="log-out" /> ログアウト
                  </button>
                </div>
              </div>
            </div>

            <div className="max-w-7xl mx-auto p-4 text-white">
              {loading && <p className="text-gray-400 text-center">読み込み中...</p>}
              {error && <div className="bg-red-900/50 border border-red-700 text-red-200 rounded-lg p-4 mb-4">{error}</div>}
              {!loading && !error && videos.length === 0 && <p className="text-gray-400 text-center">動画が見つかりませんでした</p>}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {videos.map((video) => (
                  <div key={video.id.videoId} onClick={() => setSelectedVideo(video)} className="bg-gray-800 rounded-lg overflow-hidden cursor-pointer hover:bg-gray-750 transition group relative z-10">
                    <img src={video.snippet.thumbnails.medium.url} alt={video.snippet.title} className="w-full aspect-video object-cover" />
                    <div className="p-3">
                      <h3 className="font-semibold mb-1 line-clamp-2">{video.snippet.title}</h3>
                      <p className="text-gray-400 text-sm">{video.snippet.channelTitle}</p>
                      <p className="text-gray-500 text-xs">{formatDate(video.snippet.publishedAt)}</p>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<YouTubeSubscriptionTimeline />);
    </script>
  </body>
</html>
